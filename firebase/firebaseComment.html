<!DOCTYPE html>
<html>
<head>
	<title>fire test</title>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">

	<script src="https://www.gstatic.com/firebasejs/5.7.1/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
	    apiKey: "AIzaSyCxepxkzpJ4sysUS2LjZhtZ52MaqwWVkd4",
	    authDomain: "testproject-52455.firebaseapp.com",
	    databaseURL: "https://testproject-52455.firebaseio.com",
	    projectId: "testproject-52455",
	    storageBucket: "testproject-52455.appspot.com",
	    messagingSenderId: "793011152738"
	  };
	  firebase.initializeApp(config);

	  //create new database reference "test"
	  var commentsRef = firebase.database().ref('comments/');

	  //write comments record to database
	  function writeData(id, name, img, email, comment, time) {
	  	commentsRef.push(
		  	{	
		  		id:id,
		  		name:name,
		  		img:img,
		  		email:email,
		  		comment:comment,
		  		time:time
		  	}
	  	)
	  }

	  //add comment record to database
	  	function addComment(){
	  		//init auth2 from gapi
	  		var auth2 = gapi.auth2.init()
	  		var profile = auth2.currentUser.get().getBasicProfile()
	  		//get values from profile
	  		var id = profile.getId()
	  		var name = profile.getName()
	  		var email = profile.getEmail()
	  		var img = profile.getImageUrl()
	  		var comment = document.getElementById('commentID').value
	  		var newDate = new Date()
	  		var time = newDate.toTimeString()
	  		writeData(id, name, img, email, comment, time)
	  	}

	  	//add comment element to html page
		function addCommentElement(id, name, email, img, comment, time) {
			//get comments list element
			var ele = document.getElementById("comments")
			ele.innerHTML += '<li class="list-group-item">'+'id:'+id+'<br>'+'<img width="20" height="20" src="'+img+'" />'+name+'<br>'+email+'<br>'+'<span style="color:blue">'+comment+'</span>' + '<br>' + time +'</li>'
		}

	  //add onload event listener
	  window.addEventListener("load", function() { //execute after html loading finished, to get following elements' value

	  	//add click event listener
	  	document.getElementById("buttonID").addEventListener('click',addComment)

		//excute for every existing child, and every time a new child added in database
	  	commentsRef.on('child_added', function (data) {
	  		addCommentElement(data.val().id, data.val().name, data.val().email, data.val().img, data.val().comment, data.val().time)
	  	})
	  }
	  )
	</script>

	<!--OAuth test-->
	<meta name="google-signin-client_id" content="802438001010-m1k5ms9adurv18itea8l31fbp0jig4mu.apps.googleusercontent.com">
	<script src="https://apis.google.com/js/platform.js" async defer></script>

	<!--signed in print-->
	<script type="text/javascript">
		function onSignIn(googleUser) {
			var profile = googleUser.getBasicProfile();
			console.log('ID: ' + profile.getId()); // Do not send to your backend! Use an ID token instead.
			console.log('Name: ' + profile.getName());
			console.log('Image URL: ' + profile.getImageUrl());
			console.log('Email: ' + profile.getEmail()); // This is null if the 'email' scope is not present.

			//display login info, hide login button
			document.getElementById("login").style.display = "none";
			document.getElementById("data").style.display = "block";
			document.getElementById("pic").setAttribute('src',profile.getImageUrl());
			document.getElementById("email").innerHTML = profile.getEmail();
		}

	  //signed out
	  function signOut() {
	    var auth2 = gapi.auth2.getAuthInstance();
	    auth2.signOut().then(function () {
	    	//display login button, hide login info
	    	document.getElementById("login").style.display = "inline";
	    	document.getElementById("data").style.display = "none";
	    	console.log('User signed out.');
	    });
	  }

	  //add onload event listener
	  window.addEventListener("load", function() {
	  	document.getElementById("logout").addEventListener('click',signOut)
	  })
	</script>
</head>

<body>
	<!--comments-->
	<div class="container">
		<a href="../index.html">back</a>
		<div class="row">
			Comments:
			<ul class="list-group list-group-flush" id="comments">
			</ul>
		</div>
		<!--OAuth login-->
		<div id="login" class="g-signin2" style="text-align: center;" data-onsuccess="onSignIn"></div>
	</div>

	<div id="data" class="container" style="display: none">
		<div class="row" style="display: block">
			<!--OAuth info-->
			<p>loged in as:</p>
			<img id="pic" width="100" height="100" />
			<p id="email"></p>
			<!--OAuth log out-->
			<button id="logout">Sign out</button>
		</div>
		<!--add comment-->
		<div class="row">
			<form class="form-horizontal">
				<div class="form-group">
					<textarea id="commentID" name="comment" class="form-control"></textarea>
				</div>
				<button type="button" id="buttonID" class="btn btn-danger">submit</button>
			</form>
		</div>
	</div>
</body>
</html>